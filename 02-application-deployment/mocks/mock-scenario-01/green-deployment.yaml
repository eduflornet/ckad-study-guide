apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp-green
  namespace: blue-green-prod
  labels:
    app: webapp
    version: green
    environment: production
spec:
  replicas: 3
  selector:
    matchLabels:
      app: webapp
      version: green
  template:
    metadata:
      labels:
        app: webapp
        version: green
        environment: production
    spec:
      initContainers:
      - name: db-migration
        image: node:18-alpine
        command:
        - sh
        - -c
        - |
          echo "Running database migrations for Green deployment..."
          echo "Checking database compatibility..."
          # Simulate migration with new features
          sleep 12
          echo "New feature migration completed successfully"
        env:
        - name: DB_HOST
          value: "postgres-service"
        - name: DB_USER
          value: "webapp"
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: db_password
        - name: DB_NAME
          value: "ecommerce"
      containers:
      - name: webapp
        image: node:18-alpine
        ports:
        - containerPort: 3000
        env:
        - name: PORT
          value: "3000"
        - name: NODE_ENV
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: NODE_ENV
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: LOG_LEVEL
        - name: APP_VERSION
          value: "green-v2.0.0"  # Updated version
        - name: DEPLOYMENT_COLOR
          value: "green"
        - name: DB_HOST
          value: "postgres-service"
        - name: DB_USER
          value: "webapp"
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: db_password
        - name: DB_NAME
          value: "ecommerce"
        - name: REDIS_HOST
          value: "redis-service"
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: redis_password
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: jwt_secret
        command:
        - sh
        - -c
        - |
          cat << 'NODEAPP' > app.js
          const express = require('express');
          const redis = require('redis');
          const { Pool } = require('pg');
          
          const app = express();
          const port = process.env.PORT || 3000;
          
          // Database connection
          const pool = new Pool({
            host: process.env.DB_HOST,
            user: process.env.DB_USER,
            password: process.env.DB_PASSWORD,
            database: process.env.DB_NAME,
            port: 5432,
          });
          
          // Redis connection
          const redisClient = redis.createClient({
            host: process.env.REDIS_HOST,
            port: 6379,
            password: process.env.REDIS_PASSWORD
          });
          
          // Health check endpoint
          app.get('/health', async (req, res) => {
            try {
              // Check database
              await pool.query('SELECT 1');
              
              // Check Redis
              await redisClient.ping();
              
              res.json({
                status: 'healthy',
                version: process.env.APP_VERSION,
                color: process.env.DEPLOYMENT_COLOR,
                timestamp: new Date().toISOString(),
                environment: process.env.NODE_ENV,
                checks: {
                  database: 'ok',
                  redis: 'ok',
                  newFeatureHealth: 'ok'  // New health check
                }
              });
            } catch (error) {
              res.status(500).json({
                status: 'unhealthy',
                error: error.message,
                version: process.env.APP_VERSION,
                color: process.env.DEPLOYMENT_COLOR
              });
            }
          });
          
          // Enhanced readiness check
          app.get('/ready', (req, res) => {
            res.json({
              status: 'ready',
              version: process.env.APP_VERSION,
              color: process.env.DEPLOYMENT_COLOR,
              timestamp: new Date().toISOString(),
              capabilities: ['api', 'database', 'cache', 'newFeature']
            });
          });
          
          // Main application endpoint with new features
          app.get('/', (req, res) => {
            res.json({
              message: 'E-commerce Application - Enhanced Version',
              version: process.env.APP_VERSION,
              color: process.env.DEPLOYMENT_COLOR,
              environment: process.env.NODE_ENV,
              timestamp: new Date().toISOString(),
              features: {
                analytics: true,
                notifications: true,
                newFeature: true,  // New feature enabled
                enhancedSearch: true,
                realTimeUpdates: true
              },
              performance: {
                optimized: true,
                cacheEnabled: true
              }
            });
          });
          
          // Enhanced API endpoint
          app.get('/api/products', async (req, res) => {
            try {
              const result = await pool.query('SELECT 1 as id, \'Enhanced Product\' as name, 24.99 as price, \'New features available\' as description');
              res.json({
                products: result.rows,
                version: process.env.APP_VERSION,
                color: process.env.DEPLOYMENT_COLOR,
                cached: true,  // Enhanced caching
                totalProducts: result.rows.length,
                apiVersion: 'v2'
              });
            } catch (error) {
              res.status(500).json({ error: error.message });
            }
          });
          
          // New feature endpoint
          app.get('/api/features/new', (req, res) => {
            res.json({
              feature: 'Enhanced Product Recommendations',
              version: process.env.APP_VERSION,
              color: process.env.DEPLOYMENT_COLOR,
              enabled: true,
              description: 'AI-powered product recommendations',
              performance: '50% faster response time'
            });
          });
          
          // Enhanced session endpoint
          app.get('/api/session/:userId', async (req, res) => {
            try {
              const userId = req.params.userId;
              const sessionData = {
                userId: userId,
                loginTime: new Date().toISOString(),
                version: process.env.APP_VERSION,
                color: process.env.DEPLOYMENT_COLOR,
                features: ['newFeature', 'enhancedUI'],
                sessionType: 'enhanced'
              };
              
              await redisClient.setex(`session:${userId}`, 3600, JSON.stringify(sessionData));
              
              res.json({
                message: 'Enhanced session created',
                session: sessionData
              });
            } catch (error) {
              res.status(500).json({ error: error.message });
            }
          });
          
          // Graceful shutdown
          process.on('SIGTERM', () => {
            console.log('Received SIGTERM, closing connections...');
            redisClient.quit();
            pool.end();
            process.exit(0);
          });
          
          app.listen(port, () => {
            console.log(`Green app listening on port ${port}`);
            console.log(`Version: ${process.env.APP_VERSION}`);
            console.log(`Environment: ${process.env.NODE_ENV}`);
            console.log('New features enabled!');
          });
          NODEAPP
          
          # Install dependencies and start app
          npm init -y
          npm install express redis pg
          node app.js
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
        lifecycle:
          preStop:
            exec:
              command:
              - sh
              - -c
              - "sleep 15"
---
apiVersion: v1
kind: Service
metadata:
  name: webapp-green-service
  namespace: blue-green-prod
  labels:
    app: webapp
    version: green
spec:
  selector:
    app: webapp
    version: green
  ports:
  - port: 80
    targetPort: 3000
    name: http
  type: ClusterIP
