apiVersion: apps/v1
kind: Deployment
metadata:
  name: payment-api-stable
  namespace: canary-release
  labels:
    app: payment-api
    version: stable
    track: stable
spec:
  replicas: 9  # 90% of traffic initially
  selector:
    matchLabels:
      app: payment-api
      version: stable
  template:
    metadata:
      labels:
        app: payment-api
        version: stable
        track: stable
    spec:
      containers:
      - name: payment-api
        image: node:18-alpine
        ports:
        - containerPort: 3000
        env:
        - name: PORT
          value: "3000"
        - name: NODE_ENV
          value: "production"
        - name: API_VERSION
          value: "stable-v1.5.0"
        - name: DEPLOYMENT_TRACK
          value: "stable"
        - name: DATABASE_URL
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: DATABASE_URL
        - name: REDIS_URL
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: REDIS_URL
        - name: FRAUD_API_KEY
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: fraud_api_key
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: jwt_secret
        command:
        - sh
        - -c
        - |
          cat << 'NODEAPP' > app.js
          const express = require('express');
          const crypto = require('crypto');
          const app = express();
          const port = process.env.PORT || 3000;
          
          app.use(express.json());
          
          // Global metrics
          let metrics = {
            totalTransactions: 0,
            successfulTransactions: 0,
            failedTransactions: 0,
            fraudDetected: 0,
            avgResponseTime: 0,
            uptime: Date.now()
          };
          
          // Simulate fraud detection (stable version)
          function detectFraud(transaction) {
            // Simple rule-based fraud detection
            const riskFactors = [];
            
            if (transaction.amount > 10000) {
              riskFactors.push('high_amount');
            }
            
            if (transaction.merchant === 'suspicious_merchant') {
              riskFactors.push('suspicious_merchant');
            }
            
            // 2% fraud rate in stable version
            const isFraud = Math.random() < 0.02;
            
            return {
              isFraud,
              riskScore: isFraud ? Math.random() * 0.3 + 0.7 : Math.random() * 0.3,
              riskFactors,
              algorithm: 'rule_based_v1',
              version: process.env.API_VERSION
            };
          }
          
          // Health check
          app.get('/health', (req, res) => {
            const health = {
              status: 'healthy',
              version: process.env.API_VERSION,
              track: process.env.DEPLOYMENT_TRACK,
              timestamp: new Date().toISOString(),
              uptime: Date.now() - metrics.uptime,
              metrics: {
                totalTransactions: metrics.totalTransactions,
                successRate: metrics.totalTransactions > 0 
                  ? (metrics.successfulTransactions / metrics.totalTransactions * 100).toFixed(2) + '%'
                  : '0%',
                fraudDetectionRate: metrics.totalTransactions > 0
                  ? (metrics.fraudDetected / metrics.totalTransactions * 100).toFixed(2) + '%'
                  : '0%'
              }
            };
            res.json(health);
          });
          
          // Readiness check
          app.get('/ready', (req, res) => {
            res.json({
              status: 'ready',
              version: process.env.API_VERSION,
              track: process.env.DEPLOYMENT_TRACK,
              timestamp: new Date().toISOString()
            });
          });
          
          // Main API endpoint
          app.get('/', (req, res) => {
            res.json({
              service: 'Payment API',
              version: process.env.API_VERSION,
              track: process.env.DEPLOYMENT_TRACK,
              environment: process.env.NODE_ENV,
              features: {
                fraudDetection: 'rule_based_v1',
                encryption: 'AES256',
                compliance: 'PCI_DSS',
                monitoring: 'basic'
              },
              timestamp: new Date().toISOString()
            });
          });
          
          // Process payment endpoint
          app.post('/api/payments', (req, res) => {
            const startTime = Date.now();
            metrics.totalTransactions++;
            
            try {
              const transaction = req.body;
              
              // Validate transaction
              if (!transaction.amount || !transaction.merchant || !transaction.cardNumber) {
                metrics.failedTransactions++;
                return res.status(400).json({
                  error: 'Invalid transaction data',
                  version: process.env.API_VERSION,
                  track: process.env.DEPLOYMENT_TRACK
                });
              }
              
              // Fraud detection
              const fraudCheck = detectFraud(transaction);
              
              if (fraudCheck.isFraud) {
                metrics.fraudDetected++;
                return res.status(403).json({
                  error: 'Transaction blocked - fraud detected',
                  riskScore: fraudCheck.riskScore,
                  riskFactors: fraudCheck.riskFactors,
                  version: process.env.API_VERSION,
                  track: process.env.DEPLOYMENT_TRACK
                });
              }
              
              // Simulate payment processing
              const processingTime = Math.random() * 1000 + 500; // 500-1500ms
              
              setTimeout(() => {
                // 98% success rate
                const isSuccess = Math.random() > 0.02;
                
                if (isSuccess) {
                  metrics.successfulTransactions++;
                  
                  const responseTime = Date.now() - startTime;
                  metrics.avgResponseTime = (metrics.avgResponseTime + responseTime) / 2;
                  
                  res.json({
                    transactionId: crypto.randomUUID(),
                    status: 'approved',
                    amount: transaction.amount,
                    merchant: transaction.merchant,
                    processedAt: new Date().toISOString(),
                    fraudCheck: {
                      riskScore: fraudCheck.riskScore,
                      algorithm: fraudCheck.algorithm
                    },
                    version: process.env.API_VERSION,
                    track: process.env.DEPLOYMENT_TRACK,
                    responseTime: responseTime + 'ms'
                  });
                } else {
                  metrics.failedTransactions++;
                  res.status(500).json({
                    error: 'Payment processing failed',
                    version: process.env.API_VERSION,
                    track: process.env.DEPLOYMENT_TRACK
                  });
                }
              }, processingTime);
              
            } catch (error) {
              metrics.failedTransactions++;
              res.status(500).json({
                error: 'Internal server error',
                version: process.env.API_VERSION,
                track: process.env.DEPLOYMENT_TRACK
              });
            }
          });
          
          // Metrics endpoint
          app.get('/metrics', (req, res) => {
            res.json({
              ...metrics,
              version: process.env.API_VERSION,
              track: process.env.DEPLOYMENT_TRACK,
              timestamp: new Date().toISOString()
            });
          });
          
          app.listen(port, () => {
            console.log(`Payment API (stable) listening on port ${port}`);
            console.log(`Version: ${process.env.API_VERSION}`);
          });
          NODEAPP
          
          npm init -y
          npm install express
          node app.js
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "400m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: payment-api-stable-service
  namespace: canary-release
  labels:
    app: payment-api
    version: stable
spec:
  selector:
    app: payment-api
    version: stable
  ports:
  - port: 80
    targetPort: 3000
---
# Main service that will distribute traffic
apiVersion: v1
kind: Service
metadata:
  name: payment-api-service
  namespace: canary-release
  labels:
    app: payment-api
spec:
  selector:
    app: payment-api  # Initially serves all versions
  ports:
  - port: 80
    targetPort: 3000
